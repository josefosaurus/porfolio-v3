---
import AdminLayout from '@layouts/AdminLayout.astro'
import ProtectedRoute from '@components/admin/ProtectedRoute'

const API_URL = import.meta.env.PUBLIC_CERTIFICATES_API
---

<AdminLayout title='Admin - Certificates'>
  <ProtectedRoute client:load>
    <main class='container mx-auto p-4 max-w-6xl'>
    <div class='mb-8'>
      <h1 class='text-3xl font-bold mb-2'>Certificate Management</h1>
      <p class='text-gray-600 dark:text-gray-400'>
        Add, edit, or delete certificates
      </p>
    </div>

    <!-- Add New Certificate Form -->
    <div class='bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8'>
      <h2 class='text-xl font-semibold mb-4'>Add New Certificate</h2>
      <form id='add-form' class='space-y-4'>
        <div class='grid grid-cols-1 md:grid-cols-2 gap-4'>
          <div>
            <label class='block text-sm font-medium mb-1'>Title</label>
            <input
              type='text'
              name='title'
              required
              class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
            />
          </div>
          <div>
            <label class='block text-sm font-medium mb-1'>Institution</label>
            <input
              type='text'
              name='institution'
              required
              class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
            />
          </div>
          <div>
            <label class='block text-sm font-medium mb-1'>Year</label>
            <input
              type='text'
              name='year'
              required
              class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
            />
          </div>
          <div>
            <label class='block text-sm font-medium mb-1'>Theme</label>
            <select
              name='theme'
              class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'>
              <option value='default'>Default</option>
              <option value='platzi'>Platzi</option>
              <option value='midudev'>Midudev</option>
            </select>
          </div>
          <div>
            <label class='block text-sm font-medium mb-1'>Link</label>
            <input
              type='url'
              name='link'
              required
              class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
            />
          </div>
          <div>
            <label class='block text-sm font-medium mb-1'>Certificate Image URL</label>
            <input
              type='url'
              name='image'
              required
              placeholder='https://example.com/certificate.jpg'
              class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
            />
          </div>
          <div>
            <label class='block text-sm font-medium mb-1'>Institution Badge</label>
            <div class='space-y-2'>
              <label class='block'>
                <input
                  type='file'
                  id='add-badge-file'
                  accept='image/*'
                  class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100'
                />
              </label>
              <input
                type='url'
                id='add-badge-url'
                name='badge'
                placeholder='Or paste badge URL'
                class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
              />
              <div id='add-badge-preview' class='hidden'>
                <img class='h-16 w-16 object-contain rounded border bg-white p-2' alt='Badge preview' />
              </div>
              <p id='add-upload-progress' class='text-sm text-blue-600 hidden'></p>
            </div>
          </div>
        </div>
        <button
          type='submit'
          class='bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-colors'>
          Add Certificate
        </button>
      </form>
    </div>

    <!-- Certificates List -->
    <div class='bg-white dark:bg-gray-800 rounded-lg shadow-md p-6'>
      <h2 class='text-xl font-semibold mb-4'>Existing Certificates</h2>
      <div id='certificates-list' class='space-y-4'>
        <p class='text-gray-500'>Loading certificates...</p>
      </div>
    </div>

    <!-- Edit Modal -->
    <div
      id='edit-modal'
      class='fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center'>
      <div class='bg-white dark:bg-gray-800 rounded-lg p-6 max-w-2xl w-full mx-4'>
        <h2 class='text-xl font-semibold mb-4'>Edit Certificate</h2>
        <form id='edit-form' class='space-y-4'>
          <input type='hidden' name='id' />
          <div class='grid grid-cols-1 md:grid-cols-2 gap-4'>
            <div>
              <label class='block text-sm font-medium mb-1'>Title</label>
              <input
                type='text'
                name='title'
                required
                class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
              />
            </div>
            <div>
              <label class='block text-sm font-medium mb-1'>Institution</label>
              <input
                type='text'
                name='institution'
                required
                class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
              />
            </div>
            <div>
              <label class='block text-sm font-medium mb-1'>Year</label>
              <input
                type='text'
                name='year'
                required
                class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
              />
            </div>
            <div>
              <label class='block text-sm font-medium mb-1'>Theme</label>
              <select
                name='theme'
                class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'>
                <option value='default'>Default</option>
                <option value='platzi'>Platzi</option>
                <option value='midudev'>Midudev</option>
              </select>
            </div>
            <div>
              <label class='block text-sm font-medium mb-1'>Link</label>
              <input
                type='url'
                name='link'
                required
                class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
              />
            </div>
            <div>
              <label class='block text-sm font-medium mb-1'>Certificate Image URL</label>
              <input
                type='url'
                name='image'
                required
                placeholder='https://example.com/certificate.jpg'
                class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
              />
            </div>
            <div>
              <label class='block text-sm font-medium mb-1'>Institution Badge</label>
              <div class='space-y-2'>
                <label class='block'>
                  <input
                    type='file'
                    id='edit-badge-file'
                    accept='image/*'
                    class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100'
                  />
                </label>
                <input
                  type='url'
                  id='edit-badge-url'
                  name='badge'
                  placeholder='Or paste badge URL'
                  class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
                />
                <div id='edit-badge-preview' class='hidden'>
                  <img class='h-16 w-16 object-contain rounded border bg-white p-2' alt='Badge preview' />
                </div>
                <p id='edit-upload-progress' class='text-sm text-blue-600 hidden'></p>
              </div>
            </div>
          </div>
          <div class='flex gap-2'>
            <button
              type='submit'
              class='bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-colors'>
              Save Changes
            </button>
            <button
              type='button'
              onclick='closeEditModal()'
              class='bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md transition-colors'>
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script>
    import { getIdToken, uploadImage } from '@auth/authService'

    const API_URL = import.meta.env.PUBLIC_CERTIFICATES_API

    // Extend Window interface for global functions
    declare global {
      interface Window {
        editCertificate: (id: string) => Promise<void>
        deleteCertificate: (id: string) => Promise<void>
        closeEditModal: () => void
      }
    }

    // Helper function to show image preview
    function setupImagePreview(fileInputId: string, previewDivId: string, urlInputId: string) {
      const fileInput = document.getElementById(fileInputId) as HTMLInputElement | null
      const previewDiv = document.getElementById(previewDivId)
      const urlInput = document.getElementById(urlInputId) as HTMLInputElement | null

      if (fileInput) {
        fileInput.addEventListener('change', (e) => {
          const target = e.target as HTMLInputElement
          const file = target.files?.[0]
          if (file && previewDiv) {
            const reader = new FileReader()
            reader.onload = (e) => {
              const img = previewDiv.querySelector('img')
              if (img && e.target?.result) {
                img.src = e.target.result as string
                previewDiv.classList.remove('hidden')
              }
            }
            reader.readAsDataURL(file)
            // Clear URL input when file is selected
            if (urlInput) urlInput.value = ''
          }
        })
      }

      // Clear file input when URL is pasted
      if (urlInput && previewDiv) {
        urlInput.addEventListener('input', () => {
          if (urlInput.value && fileInput) {
            fileInput.value = ''
            previewDiv.classList.add('hidden')
          }
        })
      }
    }

    // Helper function to upload badge and get URL
    async function handleBadgeUpload(fileInputId: string, urlInputId: string, progressId: string): Promise<string | null> {
      const fileInput = document.getElementById(fileInputId) as HTMLInputElement | null
      const urlInput = document.getElementById(urlInputId) as HTMLInputElement | null
      const progressEl = document.getElementById(progressId)

      // If URL is provided, use that
      if (urlInput && urlInput.value) {
        return urlInput.value
      }

      // If file is selected, upload to Firebase
      if (fileInput && fileInput.files && fileInput.files[0]) {
        try {
          if (progressEl) {
            progressEl.textContent = 'Uploading badge...'
            progressEl.classList.remove('hidden')
          }

          const file = fileInput.files[0]
          const downloadURL = await uploadImage(file, 'institution-badges')

          if (progressEl) {
            progressEl.textContent = 'Badge uploaded successfully!'
            setTimeout(() => {
              progressEl.classList.add('hidden')
            }, 2000)
          }

          return downloadURL
        } catch (error: any) {
          console.error('Error uploading badge:', error)
          if (progressEl) {
            progressEl.textContent = 'Upload failed: ' + (error?.message || 'Unknown error')
            progressEl.classList.remove('text-blue-600')
            progressEl.classList.add('text-red-600')
          }
          throw error
        }
      }

      return null
    }

    // Helper function to get auth headers
    async function getAuthHeaders() {
      const token = await getIdToken()
      if (!token) {
        window.location.href = '/admin/login'
        throw new Error('Not authenticated')
      }
      return {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`,
      }
    }

    // Helper function to handle auth errors
    function handleAuthError(response: Response): boolean {
      if (response.status === 401) {
        alert('Session expired. Please login again.')
        window.location.href = '/admin/login'
        return true
      }
      return false
    }

    // Wait for forms to be rendered by React component
    function waitForElement(selector: string, callback: () => void, maxAttempts = 20) {
      let attempts = 0
      const interval = setInterval(() => {
        const element = document.querySelector(selector)
        attempts++
        if (element || attempts >= maxAttempts) {
          clearInterval(interval)
          if (element) {
            callback()
          } else {
            console.error(`Element ${selector} not found after ${maxAttempts} attempts`)
          }
        }
      }, 100)
    }

    // Initialize when DOM is ready
    function initializeCertificatesPage() {
      // Load certificates
      async function loadCertificates() {
      try {
        const response = await fetch(API_URL)
        const certificates = await response.json()

        const listElement = document.getElementById('certificates-list')
        if (!listElement) return

        if (certificates.length === 0) {
          listElement.innerHTML =
            "<p class='text-gray-500'>No certificates found.</p>"
          return
        }

        listElement.innerHTML = certificates
          .map(
            (cert: any) => `
          <div class="border dark:border-gray-700 rounded-lg p-4 flex items-center gap-4">
            <img src="${cert.badge || cert.image}" alt="${cert.institution}" class="w-16 h-16 object-contain rounded" />
            <div class="flex-1">
              <h3 class="font-semibold">${cert.title}</h3>
              <p class="text-sm text-gray-600 dark:text-gray-400">${cert.institution} - ${cert.year}</p>
              <span class="text-xs bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded">${cert.theme}</span>
            </div>
            <div class="flex gap-2">
              <button
                onclick="editCertificate('${cert.id}')"
                class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md transition-colors">
                Edit
              </button>
              <button
                onclick="deleteCertificate('${cert.id}')"
                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md transition-colors">
                Delete
              </button>
            </div>
          </div>
        `
          )
          .join('')
      } catch (error: any) {
        console.error('Error loading certificates:', error)
        const listElement = document.getElementById('certificates-list')
        if (listElement) {
          listElement.innerHTML = "<p class='text-red-500'>Error loading certificates.</p>"
        }
      }
      }

      // Add certificate
      const addForm = document.getElementById('add-form')
      if (addForm) {
        addForm.addEventListener('submit', async (e) => {
          e.preventDefault()
          const target = e.target as HTMLFormElement
          const formData = new FormData(target)
          const data = Object.fromEntries(formData)

          try {
            // Upload badge if file is selected
            const badgeURL = await handleBadgeUpload(
              'add-badge-file',
              'add-badge-url',
              'add-upload-progress'
            )

            if (badgeURL) {
              data.badge = badgeURL
            }

            const headers = await getAuthHeaders()
            const response = await fetch(API_URL, {
              method: 'POST',
              headers,
              body: JSON.stringify(data),
            })

            if (handleAuthError(response)) return

            if (response.ok) {
              target.reset()
              const preview = document.getElementById('add-badge-preview')
              if (preview) preview.classList.add('hidden')
              loadCertificates()
              alert('Certificate added successfully!')
            } else {
              alert('Error adding certificate')
            }
          } catch (error: any) {
            console.error('Error:', error)
            alert('Error adding certificate: ' + (error?.message || 'Unknown error'))
          }
        })
      }

      // Edit certificate
      window.editCertificate = async function (id: string) {
        try {
          const response = await fetch(`${API_URL}/${id}`)
          const cert = await response.json()

          const form = document.getElementById('edit-form') as HTMLFormElement
          if (form) {
            (form.elements.namedItem('id') as HTMLInputElement).value = cert.id;
            (form.elements.namedItem('title') as HTMLInputElement).value = cert.title;
            (form.elements.namedItem('institution') as HTMLInputElement).value = cert.institution;
            (form.elements.namedItem('year') as HTMLInputElement).value = cert.year;
            (form.elements.namedItem('theme') as HTMLSelectElement).value = cert.theme;
            (form.elements.namedItem('link') as HTMLInputElement).value = cert.link;
            (form.elements.namedItem('image') as HTMLInputElement).value = cert.image

            // Set badge URL if available
            const badgeUrlInput = document.getElementById('edit-badge-url') as HTMLInputElement
            if (badgeUrlInput && cert.badge) {
              badgeUrlInput.value = cert.badge
            }

            // Clear file input and preview
            const badgeFileInput = document.getElementById('edit-badge-file') as HTMLInputElement
            if (badgeFileInput) badgeFileInput.value = ''
            const preview = document.getElementById('edit-badge-preview')
            if (preview) preview.classList.add('hidden')

            const modal = document.getElementById('edit-modal')
            if (modal) {
              modal.classList.remove('hidden')
              modal.classList.add('flex')
            }
          }
        } catch (error: any) {
          console.error('Error:', error)
          alert('Error loading certificate: ' + (error?.message || 'Unknown error'))
        }
      }

      // Save edited certificate
      const editForm = document.getElementById('edit-form')
      if (editForm) {
        editForm.addEventListener('submit', async (e) => {
          e.preventDefault()
          const target = e.target as HTMLFormElement
          const formData = new FormData(target)
          const data = Object.fromEntries(formData)
          const id = data.id
          delete data.id

          try {
            // Upload badge if file is selected
            const badgeURL = await handleBadgeUpload(
              'edit-badge-file',
              'edit-badge-url',
              'edit-upload-progress'
            )

            if (badgeURL) {
              data.badge = badgeURL
            }

            const headers = await getAuthHeaders()
            const response = await fetch(`${API_URL}/${id}`, {
              method: 'PATCH',
              headers,
              body: JSON.stringify(data),
            })

            if (handleAuthError(response)) return

            if (response.ok) {
              window.closeEditModal()
              loadCertificates()
              alert('Certificate updated successfully!')
            } else {
              alert('Error updating certificate')
            }
          } catch (error: any) {
            console.error('Error:', error)
            alert('Error updating certificate: ' + (error?.message || 'Unknown error'))
          }
        })
      }

      // Delete certificate
      window.deleteCertificate = async function (id: string) {
        if (!confirm('Are you sure you want to delete this certificate?')) return

        try {
          const headers = await getAuthHeaders()
          const response = await fetch(`${API_URL}/${id}`, {
            method: 'DELETE',
            headers,
          })

          if (handleAuthError(response)) return

          if (response.ok) {
            loadCertificates()
            alert('Certificate deleted successfully!')
          } else {
            alert('Error deleting certificate')
          }
        } catch (error: any) {
          console.error('Error:', error)
          alert('Error deleting certificate: ' + (error?.message || 'Unknown error'))
        }
      }

      // Close edit modal
      window.closeEditModal = function () {
        const modal = document.getElementById('edit-modal')
        if (modal) {
          modal.classList.add('hidden')
          modal.classList.remove('flex')
        }
      }

      // Initialize image preview handlers
      setupImagePreview('add-badge-file', 'add-badge-preview', 'add-badge-url')
      setupImagePreview('edit-badge-file', 'edit-badge-preview', 'edit-badge-url')

      // Load certificates on page load
      loadCertificates()
    }

    // Run initialization when forms are available (after ProtectedRoute renders)
    waitForElement('#add-form', initializeCertificatesPage)
  </script>
    </main>
  </ProtectedRoute>
</AdminLayout>
