---
import Layout from '@layouts/Layout.astro'

const API_URL = import.meta.env.PUBLIC_CERTIFICATES_API
---

<Layout title='Admin - Certificates'>
  <main class='container mx-auto p-4 max-w-6xl'>
    <div class='mb-8'>
      <h1 class='text-3xl font-bold mb-2'>Certificate Management</h1>
      <p class='text-gray-600 dark:text-gray-400'>
        Add, edit, or delete certificates
      </p>
    </div>

    <!-- Add New Certificate Form -->
    <div class='bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8'>
      <h2 class='text-xl font-semibold mb-4'>Add New Certificate</h2>
      <form id='add-form' class='space-y-4'>
        <div class='grid grid-cols-1 md:grid-cols-2 gap-4'>
          <div>
            <label class='block text-sm font-medium mb-1'>Title</label>
            <input
              type='text'
              name='title'
              required
              class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
            />
          </div>
          <div>
            <label class='block text-sm font-medium mb-1'>Institution</label>
            <input
              type='text'
              name='institution'
              required
              class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
            />
          </div>
          <div>
            <label class='block text-sm font-medium mb-1'>Year</label>
            <input
              type='text'
              name='year'
              required
              class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
            />
          </div>
          <div>
            <label class='block text-sm font-medium mb-1'>Theme</label>
            <select
              name='theme'
              class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'>
              <option value='default'>Default</option>
              <option value='platzi'>Platzi</option>
              <option value='midudev'>Midudev</option>
            </select>
          </div>
          <div>
            <label class='block text-sm font-medium mb-1'>Link</label>
            <input
              type='url'
              name='link'
              required
              class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
            />
          </div>
          <div>
            <label class='block text-sm font-medium mb-1'>Image URL</label>
            <input
              type='url'
              name='image'
              required
              class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
            />
          </div>
        </div>
        <button
          type='submit'
          class='bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-colors'>
          Add Certificate
        </button>
      </form>
    </div>

    <!-- Certificates List -->
    <div class='bg-white dark:bg-gray-800 rounded-lg shadow-md p-6'>
      <h2 class='text-xl font-semibold mb-4'>Existing Certificates</h2>
      <div id='certificates-list' class='space-y-4'>
        <p class='text-gray-500'>Loading certificates...</p>
      </div>
    </div>

    <!-- Edit Modal -->
    <div
      id='edit-modal'
      class='fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center'>
      <div class='bg-white dark:bg-gray-800 rounded-lg p-6 max-w-2xl w-full mx-4'>
        <h2 class='text-xl font-semibold mb-4'>Edit Certificate</h2>
        <form id='edit-form' class='space-y-4'>
          <input type='hidden' name='id' />
          <div class='grid grid-cols-1 md:grid-cols-2 gap-4'>
            <div>
              <label class='block text-sm font-medium mb-1'>Title</label>
              <input
                type='text'
                name='title'
                required
                class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
              />
            </div>
            <div>
              <label class='block text-sm font-medium mb-1'>Institution</label>
              <input
                type='text'
                name='institution'
                required
                class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
              />
            </div>
            <div>
              <label class='block text-sm font-medium mb-1'>Year</label>
              <input
                type='text'
                name='year'
                required
                class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
              />
            </div>
            <div>
              <label class='block text-sm font-medium mb-1'>Theme</label>
              <select
                name='theme'
                class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'>
                <option value='default'>Default</option>
                <option value='platzi'>Platzi</option>
                <option value='midudev'>Midudev</option>
              </select>
            </div>
            <div>
              <label class='block text-sm font-medium mb-1'>Link</label>
              <input
                type='url'
                name='link'
                required
                class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
              />
            </div>
            <div>
              <label class='block text-sm font-medium mb-1'>Image URL</label>
              <input
                type='url'
                name='image'
                required
                class='w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600'
              />
            </div>
          </div>
          <div class='flex gap-2'>
            <button
              type='submit'
              class='bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-colors'>
              Save Changes
            </button>
            <button
              type='button'
              onclick='closeEditModal()'
              class='bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md transition-colors'>
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script define:vars={{ API_URL }}>
    // Load certificates
    async function loadCertificates() {
      try {
        const response = await fetch(API_URL)
        const certificates = await response.json()

        const listElement = document.getElementById('certificates-list')
        if (certificates.length === 0) {
          listElement.innerHTML =
            "<p class='text-gray-500'>No certificates found.</p>"
          return
        }

        listElement.innerHTML = certificates
          .map(
            (cert) => `
          <div class="border dark:border-gray-700 rounded-lg p-4 flex items-center gap-4">
            <img src="${cert.image}" alt="${cert.title}" class="w-16 h-16 object-cover rounded" />
            <div class="flex-1">
              <h3 class="font-semibold">${cert.title}</h3>
              <p class="text-sm text-gray-600 dark:text-gray-400">${cert.institution} - ${cert.year}</p>
              <span class="text-xs bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded">${cert.theme}</span>
            </div>
            <div class="flex gap-2">
              <button
                onclick="editCertificate('${cert.id}')"
                class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md transition-colors">
                Edit
              </button>
              <button
                onclick="deleteCertificate('${cert.id}')"
                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md transition-colors">
                Delete
              </button>
            </div>
          </div>
        `
          )
          .join('')
      } catch (error) {
        console.error('Error loading certificates:', error)
        document.getElementById('certificates-list').innerHTML =
          "<p class='text-red-500'>Error loading certificates.</p>"
      }
    }

    // Add certificate
    document.getElementById('add-form').addEventListener('submit', async (e) => {
      e.preventDefault()
      const formData = new FormData(e.target)
      const data = Object.fromEntries(formData)

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        })

        if (response.ok) {
          e.target.reset()
          loadCertificates()
          alert('Certificate added successfully!')
        } else {
          alert('Error adding certificate')
        }
      } catch (error) {
        console.error('Error:', error)
        alert('Error adding certificate')
      }
    })

    // Edit certificate
    window.editCertificate = async function (id) {
      try {
        const response = await fetch(`${API_URL}/${id}`)
        const cert = await response.json()

        const form = document.getElementById('edit-form')
        form.elements.id.value = cert.id
        form.elements.title.value = cert.title
        form.elements.institution.value = cert.institution
        form.elements.year.value = cert.year
        form.elements.theme.value = cert.theme
        form.elements.link.value = cert.link
        form.elements.image.value = cert.image

        document.getElementById('edit-modal').classList.remove('hidden')
        document.getElementById('edit-modal').classList.add('flex')
      } catch (error) {
        console.error('Error:', error)
        alert('Error loading certificate')
      }
    }

    // Save edited certificate
    document
      .getElementById('edit-form')
      .addEventListener('submit', async (e) => {
        e.preventDefault()
        const formData = new FormData(e.target)
        const data = Object.fromEntries(formData)
        const id = data.id
        delete data.id

        try {
          const response = await fetch(`${API_URL}/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          })

          if (response.ok) {
            closeEditModal()
            loadCertificates()
            alert('Certificate updated successfully!')
          } else {
            alert('Error updating certificate')
          }
        } catch (error) {
          console.error('Error:', error)
          alert('Error updating certificate')
        }
      })

    // Delete certificate
    window.deleteCertificate = async function (id) {
      if (!confirm('Are you sure you want to delete this certificate?')) return

      try {
        const response = await fetch(`${API_URL}/${id}`, {
          method: 'DELETE',
        })

        if (response.ok) {
          loadCertificates()
          alert('Certificate deleted successfully!')
        } else {
          alert('Error deleting certificate')
        }
      } catch (error) {
        console.error('Error:', error)
        alert('Error deleting certificate')
      }
    }

    // Close edit modal
    window.closeEditModal = function () {
      document.getElementById('edit-modal').classList.add('hidden')
      document.getElementById('edit-modal').classList.remove('flex')
    }

    // Load certificates on page load
    loadCertificates()
  </script>
</Layout>
